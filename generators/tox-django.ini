[tox]
envlist = django{22,30}
skip_install = True
skipsdist = True

[testenv]
description = Generate 12-factor Django project
recreate = True
deps =
    autopep8
    django22: Django>=2.2,<3.0
    django30: Django>=3.0,<3.1
    django-debug-toolbar
    django-environ
    flake8-django
    pylint-django
commands =
    # NOTE: platform independent solution for `mkdir -p {toxworkdir}/{envname}/_`
    python -c "import os; os.mkdir('{toxworkdir}/{envname}/_')"
    django-admin startproject application {toxworkdir}/{envname}/_
    # TODO: Fix for non-Unices by using Python (OS X would need gsed)
    sed -i -E \
        -e '/^Generated by .django-admin startproject. using Django/d' \
        -e '/^For more information on this file, see/d' \
        -e '/^For the full list of settings and their values, see/d' \
        -e '/^https:..docs.djangoproject.com.en..*.settings/d' \
        -e '/^# Quick-start development settings - unsuitable for production/d' \
        -e '/^# https:..docs.djangoproject.com.en./d' \
        -e '/^# See https:..docs.djangoproject.com.en./d' \
        -e '/^# Build paths inside the project like this:/d' \
        -e 's/^import os/from os.path import abspath, dirname, join\nfrom environ import Env\n\nenv = Env()  # pylint: disable=invalid-name/' \
        -e 's/os.path.dirname.os.path.dirname.os.path.abspath.__file__.../dirname(dirname(abspath(__file__)))/' \
        -e 's/os.path.join./join(/g' \
        -e "s/^SECRET_KEY = .*$/DEBUG = env.bool('DJANGO_DEBUG', default=False)\n\nSECRET_KEY = 'dummy-secret' if DEBUG else env('DJANGO_SECRET_KEY')/" \
        -e "s/^(ALLOWED_HOSTS = ).*$/\1\['*'\]/" \
        -e "s#^STATIC_URL = .*$#STATIC_ROOT = join(BASE_DIR, 'static')\nSTATIC_URL = '/static/'\nMEDIA_ROOT = join(BASE_DIR, 'media')\nMEDIA_URL = '/media/'#" \
        -e '/^DEBUG = True$/d' \
        -e '/^# SECURITY WARNING: /d' \
        {toxworkdir}/{envname}/_/application/settings.py
    sed -i -E -z \
        -e "s/\n(        )('NAME': 'django.contrib.auth.password_validation.)([A-Za-z]*',)/\n\1\2'\n\1\1'\3/g" \
        -e "s/(\nALLOWED_HOSTS = .....\n)/\1\nLOGGING = \{\n    'version': 1,\n    'disable_existing_loggers': False,\n    'handlers': \{\n        'console': \{\n            'level': env('DJANGO_LOG_LEVEL', default='INFO'),\n            'class': 'logging.StreamHandler',\n        \},\n    \},\n    'loggers': \{\n        'django': \{\n            'handlers': ['console'],\n        \},\n        'django.request': \{\n            'handlers': ['console'],\n            'level': 'ERROR',\n        \},\n    \},\n\}\n/" \
        {toxworkdir}/{envname}/_/application/settings.py
    sed -i -E -z \
        -e 's/(from django.contrib import admin)/from django.conf import settings\n\1/' \
        -e 's/from django.urls import path/from django.urls import include, path/' \
        -e "s|$|\nif settings.DEBUG:\n    import debug_toolbar  # pylint: disable=import-error\n\n    urlpatterns = [\n        path('__debug__/', include(debug_toolbar.urls)),\n    ] + urlpatterns\n|" \
        {toxworkdir}/{envname}/_/application/urls.py
    # TODO: Add LANGUAGES = [('en', _('English')),] next to LANGUAGE_CODE = 'en'
    # TODO: Add LocaleMiddleware (between SessionMiddleware and CommonMiddleware)
    # TODO: Accomodate SITE_ID / django.contrib.sites or make it unneeded
    # TODO: ensure static and media folders exist and have proper permissions
    # TODO: Add Django default templates in application app (base, 400, 403, 440, 500)
    # TODO: Add minimal Hello World! app
    autopep8 --in-place {toxworkdir}/{envname}/_/application/settings.py
    flake8 {toxworkdir}/{envname}/_/
    pylint {toxworkdir}/{envname}/_/application --load-plugins=pylint_django
    sed -i -E -z \
        -e "s/(MIDDLEWARE = .)(\n    )/\1\2\{%- if cookiecutter.monitoring == 'Datadog' %\}\2'django_datadog.middleware.DatadogMiddleware',\2\{%- endif %\}\2/" \
        -e "s/(\n    )('django.contrib.staticfiles',)/\1\2\1\{%- if cookiecutter.monitoring == 'Datadog' %\}\1'django_datadog',\1\{%- endif %\}\1'django_probes',/" \
        -e "s#(DATABASES = .\n    'default':) .(\n        )'ENGINE': .* 'NAME': join.BASE_DIR, 'db.sqlite3'.,(\n    ).#\1 env.db(\2'DJANGO_DATABASE_URL',\2\{%- if cookiecutter.database == '(none)' %}\2default='sqlite://%s' % join(BASE_DIR, 'db.sqlite3')\2\{%- elif cookiecutter.database == 'Postgres' %\}\2default='postgres://postgres:postgres@database/postgres'\2\{%- elif cookiecutter.database == 'MySQL' %\}\2default='mysql://mysql:mysql@database/mysql'\2\{%- endif %\}\3),#" \
        -e "s/(\nenv = Env..[A-Za-z #:=-]*\n)/\1\nENVIRONMENT = env('ENVIRONMENT', default='local')\nREVISION = env('REVISION', default=None)\n\{%- if cookiecutter.monitoring == 'Sentry' %\}\nSENTRY_DSN = env('SENTRY_DSN', default=None)\n\nif SENTRY_DSN:\n    import sentry_sdk\n    from sentry_sdk.integrations.django import DjangoIntegration\n\n    sentry_sdk.init(\n        dsn=SENTRY_DSN,\n        integrations=[DjangoIntegration()],\n        environment=ENVIRONMENT,\n        release=REVISION)\n\{%- endif %\}\n/" \
        -e "s/\n(\nTIME_ZONE)/\1/" \
        -e "s/\n(\nUSE_I18N)/\1/" \
        -e "s/\n(\nUSE_L10N)/\1/" \
        -e "s/\n(\nUSE_TZ)/\1/" \
        {toxworkdir}/{envname}/_/application/settings.py
    sed -i -z \
        -e "s/$/\nif DEBUG:\n    DEBUG_TOOLBAR_CONFIG = \{\n        'SHOW_TEMPLATE_CONTEXT': True,\n        'SHOW_TOOLBAR_CALLBACK': lambda request: True,\n    \}\n    MIDDLEWARE += ['debug_toolbar.middleware.DebugToolbarMiddleware']\n    INSTALLED_APPS += ['debug_toolbar']\n/" \
        -e "s/$/\n\nif SECRET_KEY == 'testing':\n    INSTALLED_APPS += ['behave_django']\n/" \
        -e "s/$/\{%- if cookiecutter.monitoring == 'Datadog' %\}\n\nDATADOG_API_KEY = env('DATADOG_API_KEY', default=None)\nDATADOG_APP_KEY = env('DATADOG_APP_KEY', default=None)\nDATADOG_APP_NAME = env('DATADOG_APP_NAME', default=None)\n\{%- elif cookiecutter.monitoring == 'NewRelic' %\}\n\nNEWRELIC_LICENSE_KEY = env('NEWRELIC_LICENSE_KEY', default=None)\n\nif NEWRELIC_LICENSE_KEY:\n    import newrelic.agent\n\n    newrelic.agent.initialize(join(BASE_DIR, 'newrelic.ini'))\n\{%- endif %\}\n/" \
        -e 's/\n\n\n\n"""\n\n/\n"""\n/g' \
        -e 's/\n\n\n/\n\n/g' \
        {toxworkdir}/{envname}/_/application/settings.py
    sed -i -E -z \
        -e 's/(\n"""\n)\n(import)/\1\2/g' \
        {toxworkdir}/{envname}/_/application/wsgi.py
    sed -i -z \
        -e 's/\n    try:\n    /\n\n/' \
        -e 's/\n    except ImportError .* from exc\n/\n\n/' \
        {toxworkdir}/{envname}/_/manage.py
whitelist_externals =
    sed
