  - step: &build
      name: Build image
      image: docker.io/library/docker
      caches:
      - docker
      script:
      - REGISTRY={{ cookiecutter.docker_registry }}
        TARGET={{ cookiecutter.project_slug }}{% if cookiecutter.environment_strategy == 'dedicated' %}-${BITBUCKET_DEPLOYMENT_ENVIRONMENT}{% endif %}
        IMAGE="${REGISTRY}/${TARGET}/${BITBUCKET_REPO_SLUG}"
      - docker login -u bitbucket-pipelines -p ${KUBE_TOKEN} ${REGISTRY}
      - docker pull "${IMAGE}:latest" || true
      - docker build -t "${IMAGE}:${BITBUCKET_COMMIT}"
                     -t "${IMAGE}:latest"
                     -f "deployment/application/Dockerfile" .
      - docker push "${IMAGE}"
