
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://docker:2375
  DOCKER_REGISTRY: {{ cookiecutter.docker_registry }}
{%- if cookiecutter.environment_strategy == 'shared' %}
  TARGET: {{ cookiecutter.project_slug }}
{%- endif %}

services:
  - name: docker:dind

stages:
- check
- test
- build
- deploy

.check:
  stage: check
  image: docker.io/painless/tox
  only:
  - merge_requests
  - master

.test:
  stage: test
  image: docker.io/painless/tox
  only:
  - merge_requests
  - master

.build:
  stage: build
  image: docker.io/library/docker
  variables:
    IMAGE: ${DOCKER_REGISTRY}/${TARGET}/${CI_PROJECT_NAME}
  before_script:
  - docker login -u gitlab-ci -p ${KUBE_TOKEN} ${DOCKER_REGISTRY}
  - docker pull "${IMAGE}:latest" || true
  script:
  - docker build -t "${IMAGE}:${CI_COMMIT_SHA}"
                 -t "${IMAGE}:latest"
                 -f "deployment/application/Dockerfile" .
  - docker push "${IMAGE}"

.generate-secrets:
  variables:
    APPLICATION_NAME: application{% if cookiecutter.environment_strategy == 'shared' %}-${CI_ENVIRONMENT_NAME}{% endif %}
    DATABASE_NAME: postgres{% if cookiecutter.environment_strategy == 'shared' %}-${CI_ENVIRONMENT_NAME}{% endif %}
  before_script:
  - DJANGO_SECRET_KEY=$(cat /dev/urandom | tr -dc A-Za-z0-9 | head -c50)
    POSTGRES_PASSWORD=$(cat /dev/urandom | tr -dc A-Za-z0-9 | head -c16)
    true
  - kubectl -n ${TARGET} get secret ${APPLICATION_NAME} ||
    kubectl -n ${TARGET} create secret generic ${APPLICATION_NAME}
    --from-literal=DJANGO_DATABASE_URL=postgres://{{ cookiecutter.project_slug.replace('-', '_') }}:${POSTGRES_PASSWORD}@${DATABASE_NAME}/{{ cookiecutter.project_slug.replace('-', '_') }}
    --from-literal=DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
  - kubectl -n ${TARGET} get secret ${DATABASE_NAME} ||
    kubectl -n ${TARGET} create secret generic ${DATABASE_NAME}
    --from-literal=POSTGRESQL_DATABASE={{ cookiecutter.project_slug.replace('-', '_') }}
    --from-literal=POSTGRESQL_USER={{ cookiecutter.project_slug.replace('-', '_') }}
    --from-literal=POSTGRESQL_PASSWORD=${POSTGRES_PASSWORD}

.deploy:
  stage: deploy
  extends: .generate-secrets
  environment:
    url: "${KUBE_URL}/console/project/{{ cookiecutter.project_slug }}{% if cookiecutter.environment_strategy == 'dedicated' %}-${CI_ENVIRONMENT_NAME}{% endif %}/overview"
  image: docker.io/appuio/oc:v3.11
  script:
{%- if cookiecutter.environment_strategy == 'dedicated' %}
  - oc tag "${SOURCE}/${CI_PROJECT_NAME}:${CI_COMMIT_SHA}"
           "${TARGET}/${CI_PROJECT_NAME}:${CI_COMMIT_SHA}"
{%- endif %}
  - pushd deployment/application/base &&
{%- if cookiecutter.environment_strategy == 'dedicated' %}
    kustomize edit set namesuffix -- "-${CI_ENVIRONMENT_NAME}" &&
{%- endif %}
    kustomize edit set image IMAGE="${DOCKER_REGISTRY}/${TARGET}/${CI_PROJECT_NAME}:${CI_COMMIT_SHA}" &&
    popd
{%- if cookiecutter.environment_strategy == 'dedicated' %}
  - pushd deployment/database/base &&
    kustomize edit set namesuffix -- "-${CI_ENVIRONMENT_NAME}" &&
    popd
{%- endif %}
  - kustomize build deployment/application/overlays/${CI_ENVIRONMENT_NAME} | kubeval --strict --ignore-missing-schemas
  - kustomize build deployment/database/overlays/${CI_ENVIRONMENT_NAME} | kubeval --strict
  - kustomize build deployment/application/overlays/${CI_ENVIRONMENT_NAME} | kubectl -n ${TARGET} apply -f -
  - kustomize build deployment/database/overlays/${CI_ENVIRONMENT_NAME} | kubectl -n ${TARGET} apply -f -
