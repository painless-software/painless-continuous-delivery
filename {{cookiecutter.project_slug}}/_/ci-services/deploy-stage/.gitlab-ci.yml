{%- if cookiecutter.gitops == 'false' %}
review:
  extends: .deploy
  environment:
    name: development
    on_stop: stop_review
    auto_stop_in: 18 hours
  variables:
    SUFFIX: -review-mr${CI_MERGE_REQUEST_IID}
    LABEL: {{ cookiecutter.project_slug }}-review-mr${CI_MERGE_REQUEST_IID}
    APPLICATION: application-review-mr${CI_MERGE_REQUEST_IID}
    DATABASE_HOST: {{ cookiecutter.database|lower }}-review-mr${CI_MERGE_REQUEST_IID}
    IMAGE_TAG: ${CI_COMMIT_SHA}
  only:
  - merge_requests

stop_review:
  extends: review
  environment:
    action: stop
  variables:
    GIT_STRATEGY: none
  when: manual
  before_script:
  script:
  - oc delete all,configmap,pvc,secret -n ${TARGET} -l app=${LABEL}

integration:
  extends: .deploy
  environment:
    name: integration
  variables:
{%- if cookiecutter.environment_strategy == 'shared' %}
    SUFFIX: -integration
    LABEL: {{ cookiecutter.project_slug }}-integration
{%- else %}
    SOURCE: {{ cookiecutter.cloud_project }}-development
    TARGET: {{ cookiecutter.cloud_project }}-integration
{%- endif %}
    IMAGE_TAG: ${CI_COMMIT_SHA}
  only:
  - master

production:
  extends: .deploy
  environment:
    name: production
  variables:
{%- if cookiecutter.environment_strategy == 'shared' %}
    SUFFIX: -production
    LABEL: {{ cookiecutter.project_slug }}-production
{%- else %}
    SOURCE: {{ cookiecutter.cloud_project }}-integration
    TARGET: {{ cookiecutter.cloud_project }}-production
{%- endif %}
    IMAGE_TAG: ${CI_COMMIT_TAG}
  only:
  - tags
{%- endif %}
{%- if cookiecutter.gitops == 'true' %}
production_tag:
  stage: tag
  image: docker.io/library/docker
  services:
  - name: docker:dind
  variables:
    IMAGE: ${REGISTRY}/${TARGET}/{{ cookiecutter.project_slug }}
    TARGET: {{ cookiecutter.cloud_project }}{% if cookiecutter.environment_strategy == 'dedicated' %}-development{% endif %}
  before_script:
  - docker login -u gitlab-ci -p ${KUBE_TOKEN} ${REGISTRY}
  script:
  - docker pull "${IMAGE}:${CI_COMMIT_SHA}"
  - docker tag "${IMAGE}:${CI_COMMIT_SHA}" "${IMAGE}:${CI_COMMIT_TAG}"
  - docker push "${IMAGE}"
  only:
  - tags
{%- endif %}
